import chess
import chess.pgn
import json


def extract_openings(pgn_file, max_ply=10):
    openings = {}

    with open(pgn_file) as pgn:
        while True:
            game = chess.pgn.read_game(pgn)
            if game is None:
                break

            board = game.board()
            ply_count = 0

            for move in game.mainline_moves():
                # Lưu vị trí hiện tại trước khi thực hiện nước đi
                fen = board.fen()

                # Thực hiện nước đi để lấy nước đi tiếp theo
                board.push(move)
                ply_count += 1

                # Chỉ lưu các vị trí trong giai đoạn khai cuộc (max_ply)
                if ply_count > max_ply:
                    break

                # Lưu nước đi tiếp theo (move) cho vị trí FEN hiện tại
                if fen in openings:
                    move_uci = move.uci()
                    if move_uci not in openings[fen]:
                        openings[fen].append(move_uci)
                else:
                    openings[fen] = [move.uci()]

    return openings


def save_openings(openings, output_file):
    with open(output_file, "w") as f:
        json.dump(openings, f, indent=4)


if __name__ == "__main__":
    pgn_file = "Caro-KannClassic.pgn"
    output_file = "opening.json"
    openings = extract_openings(pgn_file, max_ply=10)
    save_openings(openings, output_file)